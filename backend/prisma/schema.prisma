// ═══════════════════════════════════════════════════════════════════════════
// PRISMA SCHEMA - PRIVY SYSTEM
// Fresh database for Privy-authenticated users (TMA)
// Legacy WHEEL token remains on Supabase
// ═══════════════════════════════════════════════════════════════════════════

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("PRIVY_DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════════════════
// PRIVY USERS
// Users authenticated via Privy (Telegram, email, or wallet)
// ═══════════════════════════════════════════════════════════════════════════

model PrivyUser {
  id               String   @id @default(uuid())
  privyUserId      String   @unique @map("privy_user_id")
  telegramId       BigInt?  @unique @map("telegram_id")
  email            String?  @unique
  walletAddress    String?  @unique @map("wallet_address")
  telegramUsername String?  @map("telegram_username")
  displayName      String?  @map("display_name")
  walletsDelegated Boolean  @default(false) @map("wallets_delegated")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  wallets         PrivyWallet[]
  tokens          PrivyUserToken[]
  pendingLaunches PrivyPendingLaunch[]
  mmPending       PrivyMmPending[]
  adminRole       AdminRole?
  telegramUser    TelegramUser?

  @@map("privy_users")
}

// ═══════════════════════════════════════════════════════════════════════════
// PRIVY WALLETS
// Embedded wallets managed by Privy OR imported wallets with encrypted keys
// ═══════════════════════════════════════════════════════════════════════════

model PrivyWallet {
  id            String   @id @default(uuid())
  privyUserId   String   @map("privy_user_id")
  walletType    String   @map("wallet_type") // 'dev' | 'ops'
  walletAddress String   @unique @map("wallet_address")
  privyWalletId String   @map("privy_wallet_id")
  chainType     String   @default("solana") @map("chain_type")
  createdAt     DateTime @default(now()) @map("created_at")

  // Imported wallet fields (for wallets not managed by Privy)
  isImported          Boolean @default(false) @map("is_imported")
  encryptedPrivateKey String? @map("encrypted_private_key")
  encryptionIv        String? @map("encryption_iv")
  encryptionAuthTag   String? @map("encryption_auth_tag")

  user               PrivyUser            @relation(fields: [privyUserId], references: [privyUserId], onDelete: Cascade)
  devTokens          PrivyUserToken[]     @relation("DevWallet")
  opsTokens          PrivyUserToken[]     @relation("OpsWallet")
  devPendingLaunches PrivyPendingLaunch[] @relation("DevWalletLaunch")
  opsPendingLaunches PrivyPendingLaunch[] @relation("OpsWalletLaunch")
  mmPending          PrivyMmPending[]     @relation("MmOpsWallet")

  @@unique([privyUserId, walletType])
  @@index([walletAddress])
  @@map("privy_wallets")
}

// ═══════════════════════════════════════════════════════════════════════════
// PRIVY USER TOKENS
// Tokens registered by Privy users (linked to wallets, not encrypted keys)
// ═══════════════════════════════════════════════════════════════════════════

model PrivyUserToken {
  id                  String   @id @default(uuid())
  privyUserId         String   @map("privy_user_id")
  tokenMintAddress    String   @map("token_mint_address")
  tokenSymbol         String   @map("token_symbol")
  tokenName           String?  @map("token_name")
  tokenImage          String?  @map("token_image")
  tokenDecimals       Int      @default(6) @map("token_decimals")
  devWalletId         String   @map("dev_wallet_id")
  opsWalletId         String   @map("ops_wallet_id")
  isActive            Boolean  @default(true) @map("is_active")
  isGraduated         Boolean  @default(false) @map("is_graduated")
  launchedViaTelegram Boolean  @default(false) @map("launched_via_telegram")
  tokenSource         String   @default("launched") @map("token_source") // 'launched' | 'registered' | 'mm_only'
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  user          PrivyUser           @relation(fields: [privyUserId], references: [privyUserId], onDelete: Cascade)
  devWallet     PrivyWallet         @relation("DevWallet", fields: [devWalletId], references: [id])
  opsWallet     PrivyWallet         @relation("OpsWallet", fields: [opsWalletId], references: [id])
  config        PrivyTokenConfig?
  flywheelState PrivyFlywheelState?
  transactions  PrivyTransaction[]
  claims        PrivyClaimHistory[]

  @@unique([privyUserId, tokenMintAddress])
  @@index([tokenMintAddress])
  @@index([isActive])
  @@map("privy_user_tokens")
}

// ═══════════════════════════════════════════════════════════════════════════
// PRIVY TOKEN CONFIG
// Per-token flywheel and market making configuration
// ═══════════════════════════════════════════════════════════════════════════

model PrivyTokenConfig {
  id                    String   @id @default(uuid())
  privyTokenId          String   @unique @map("privy_token_id")
  flywheelActive        Boolean  @default(false) @map("flywheel_active")
  marketMakingEnabled   Boolean  @default(false) @map("market_making_enabled")
  autoClaimEnabled      Boolean  @default(true) @map("auto_claim_enabled")
  feeThresholdSol       Decimal  @default(0.01) @map("fee_threshold_sol") @db.Decimal(20, 9)
  slippageBps           Int      @default(300) @map("slippage_bps")
  tradingRoute          String   @default("auto") @map("trading_route")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Percentage-based trading (simple algorithm)
  buyPercent            Int      @default(20) @map("buy_percent")  // % of SOL balance to use for buys
  sellPercent           Int      @default(20) @map("sell_percent") // % of token balance to use for sells

  // Legacy fields - kept for backwards compatibility but not used
  minBuyAmountSol       Decimal  @default(0.01) @map("min_buy_amount_sol") @db.Decimal(20, 9)
  maxBuyAmountSol       Decimal  @default(0.1) @map("max_buy_amount_sol") @db.Decimal(20, 9)
  maxSellAmountTokens   Decimal  @default(1000000) @map("max_sell_amount_tokens") @db.Decimal(30, 9)
  buyIntervalMinutes    Int      @default(5) @map("buy_interval_minutes")
  algorithmMode         String   @default("simple") @map("algorithm_mode")
  targetSolAllocation   Int      @default(30) @map("target_sol_allocation")
  targetTokenAllocation Int      @default(70) @map("target_token_allocation")
  rebalanceThreshold    Int      @default(10) @map("rebalance_threshold")
  twapEnabled           Boolean  @default(true) @map("twap_enabled")
  twapSlices            Int      @default(5) @map("twap_slices")
  twapWindowMinutes     Int      @default(30) @map("twap_window_minutes")
  twapThresholdUsd      Decimal  @default(50) @map("twap_threshold_usd") @db.Decimal(20, 2)
  vwapEnabled           Boolean  @default(true) @map("vwap_enabled")
  vwapParticipationRate Int      @default(10) @map("vwap_participation_rate")
  vwapMinVolumeUsd      Decimal  @default(1000) @map("vwap_min_volume_usd") @db.Decimal(20, 2)
  dynamicFeeEnabled         Boolean @default(true) @map("dynamic_fee_enabled")
  reservePercentNormal      Int     @default(10) @map("reserve_percent_normal")
  reservePercentAdverse     Int     @default(20) @map("reserve_percent_adverse")
  minSellPercent            Int     @default(10) @map("min_sell_percent")
  maxSellPercent            Int     @default(30) @map("max_sell_percent")
  buybackBoostOnDump        Boolean @default(true) @map("buyback_boost_on_dump")
  pauseOnExtremeVolatility  Boolean @default(true) @map("pause_on_extreme_volatility")
  volatilityPauseThreshold  Int     @default(15) @map("volatility_pause_threshold")

  token PrivyUserToken @relation(fields: [privyTokenId], references: [id], onDelete: Cascade)

  @@index([flywheelActive])
  @@index([algorithmMode])
  @@map("privy_token_config")
}

// ═══════════════════════════════════════════════════════════════════════════
// PRIVY FLYWHEEL STATE
// Algorithm state for recovery after restarts
// ═══════════════════════════════════════════════════════════════════════════

model PrivyFlywheelState {
  id                     String    @id @default(uuid())
  privyTokenId           String    @unique @map("privy_token_id")
  cyclePhase             String    @default("buy") @map("cycle_phase")
  buyCount               Int       @default(0) @map("buy_count")
  sellCount              Int       @default(0) @map("sell_count")
  sellPhaseTokenSnapshot Decimal   @default(0) @map("sell_phase_token_snapshot") @db.Decimal(30, 9)
  sellAmountPerTx        Decimal   @default(0) @map("sell_amount_per_tx") @db.Decimal(30, 9)
  lastTradeAt            DateTime? @map("last_trade_at")
  consecutiveFailures    Int       @default(0) @map("consecutive_failures")
  lastFailureReason      String?   @map("last_failure_reason")
  lastFailureAt          DateTime? @map("last_failure_at")
  pausedUntil            DateTime? @map("paused_until")
  totalFailures          Int       @default(0) @map("total_failures")
  lastCheckedAt          DateTime? @map("last_checked_at")
  lastCheckResult        String?   @map("last_check_result")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  // Dynamic Mode State (market condition tracking and reserve)
  marketCondition         String    @default("normal") @map("market_condition") // pump, dump, ranging, normal, extreme_volatility
  previousMarketCondition String    @default("normal") @map("previous_market_condition")
  lastConditionChangeAt   DateTime? @map("last_condition_change_at")
  reserveBalanceSol       Decimal   @default(0) @map("reserve_balance_sol") @db.Decimal(20, 9)
  twapQueue               Json      @default("[]") @map("twap_queue")

  token PrivyUserToken @relation(fields: [privyTokenId], references: [id], onDelete: Cascade)

  @@index([marketCondition])
  @@map("privy_flywheel_state")
}

// ═══════════════════════════════════════════════════════════════════════════
// PRIVY PENDING LAUNCHES
// Token launches awaiting deposit confirmation
// ═══════════════════════════════════════════════════════════════════════════

model PrivyPendingLaunch {
  id               String    @id @default(uuid())
  privyUserId      String    @map("privy_user_id")
  tokenName        String    @map("token_name")
  tokenSymbol      String    @map("token_symbol")
  tokenDescription String?   @map("token_description")
  tokenImageUrl    String?   @map("token_image_url")
  twitterUrl       String?   @map("twitter_url")
  telegramUrl      String?   @map("telegram_url")
  websiteUrl       String?   @map("website_url")
  discordUrl       String?   @map("discord_url")
  devWalletId      String    @map("dev_wallet_id")
  opsWalletId      String    @map("ops_wallet_id")
  status           String    @default("awaiting_deposit")
  depositAddress   String    @map("deposit_address")
  minDepositSol    Decimal   @default(0.1) @map("min_deposit_sol") @db.Decimal(20, 9)
  devBuySol        Decimal   @default(0) @map("dev_buy_sol") @db.Decimal(20, 9)
  expiresAt        DateTime  @map("expires_at")
  launchedAt       DateTime? @map("launched_at")
  retryCount       Int       @default(0) @map("retry_count")
  lastError        String?   @map("last_error")
  tokenMintAddress String?   @map("token_mint_address")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // MM Config - user-selected market making preferences
  mmAlgorithm      String    @default("simple") @map("mm_algorithm") // simple, rebalance, twap_vwap, dynamic
  mmMinBuySol      Decimal   @default(0.01) @map("mm_min_buy_sol") @db.Decimal(20, 9)
  mmMaxBuySol      Decimal   @default(0.05) @map("mm_max_buy_sol") @db.Decimal(20, 9)
  mmAutoClaimEnabled Boolean @default(true) @map("mm_auto_claim_enabled")

  user      PrivyUser   @relation(fields: [privyUserId], references: [privyUserId])
  devWallet PrivyWallet @relation("DevWalletLaunch", fields: [devWalletId], references: [id])
  opsWallet PrivyWallet @relation("OpsWalletLaunch", fields: [opsWalletId], references: [id])

  @@index([status])
  @@index([expiresAt])
  @@map("privy_pending_launches")
}

// ═══════════════════════════════════════════════════════════════════════════
// PRIVY TRANSACTIONS
// All trading transactions (buy, sell, transfer, claim)
// ═══════════════════════════════════════════════════════════════════════════

model PrivyTransaction {
  id            String    @id @default(uuid())
  privyTokenId  String    @map("privy_token_id")
  type          String    // 'buy' | 'sell' | 'transfer' | 'claim'
  amount        Decimal   @db.Decimal(30, 9)
  amountUsd     Decimal?  @map("amount_usd") @db.Decimal(20, 2)
  message       String?
  signature     String?   @unique
  status        String    @default("pending")
  inputMint     String?   @map("input_mint")
  outputMint    String?   @map("output_mint")
  inputAmount   Decimal?  @map("input_amount") @db.Decimal(30, 9)
  outputAmount  Decimal?  @map("output_amount") @db.Decimal(30, 9)
  pricePerToken Decimal?  @map("price_per_token") @db.Decimal(30, 15)
  slippageBps   Int?      @map("slippage_bps")
  tradingRoute  String?   @map("trading_route")
  errorMessage  String?   @map("error_message")
  createdAt     DateTime  @default(now()) @map("created_at")
  confirmedAt   DateTime? @map("confirmed_at")

  token PrivyUserToken @relation(fields: [privyTokenId], references: [id], onDelete: Cascade)

  @@index([privyTokenId])
  @@index([type])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("privy_transactions")
}

// ═══════════════════════════════════════════════════════════════════════════
// PRIVY CLAIM HISTORY
// Fee claims with platform fee tracking (10% platform, 90% user)
// ═══════════════════════════════════════════════════════════════════════════

model PrivyClaimHistory {
  id                   String    @id @default(uuid())
  privyTokenId         String    @map("privy_token_id")
  amountSol            Decimal?  @map("amount_sol") @db.Decimal(20, 9)
  totalAmountSol       Decimal?  @map("total_amount_sol") @db.Decimal(20, 9)
  amountUsd            Decimal?  @map("amount_usd") @db.Decimal(20, 2)
  platformFeeSol       Decimal   @map("platform_fee_sol") @db.Decimal(20, 9)
  userReceivedSol      Decimal   @map("user_received_sol") @db.Decimal(20, 9)
  transactionSignature String?   @map("transaction_signature")
  claimSignature       String?   @map("claim_signature")
  transferSignature    String?   @map("transfer_signature")
  status               String    @default("completed")
  errorMessage         String?   @map("error_message")
  createdAt            DateTime  @default(now()) @map("created_at")
  claimedAt            DateTime? @map("claimed_at")
  completedAt          DateTime? @map("completed_at")

  token PrivyUserToken @relation(fields: [privyTokenId], references: [id], onDelete: Cascade)

  @@index([privyTokenId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("privy_claim_history")
}

// ═══════════════════════════════════════════════════════════════════════════
// PRIVY MM PENDING
// MM-only mode: user funds ops wallet to market-make any Bags token
// ═══════════════════════════════════════════════════════════════════════════

model PrivyMmPending {
  id               String   @id @default(uuid())
  privyUserId      String   @map("privy_user_id")
  tokenMintAddress String   @map("token_mint_address")
  tokenSymbol      String   @map("token_symbol")
  tokenName        String?  @map("token_name")
  tokenImage       String?  @map("token_image")
  tokenDecimals    Int      @default(6) @map("token_decimals")
  opsWalletId      String   @map("ops_wallet_id")
  depositAddress   String   @map("deposit_address")
  minDepositSol    Decimal  @default(0.1) @map("min_deposit_sol") @db.Decimal(20, 9)
  mmAlgorithm      String   @default("simple") @map("mm_algorithm") // simple, rebalance, twap_vwap, dynamic
  status           String   @default("awaiting_deposit") // awaiting_deposit, active, cancelled, expired
  expiresAt        DateTime @map("expires_at")
  activatedAt      DateTime? @map("activated_at")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  user      PrivyUser   @relation(fields: [privyUserId], references: [privyUserId], onDelete: Cascade)
  opsWallet PrivyWallet @relation("MmOpsWallet", fields: [opsWalletId], references: [id])

  @@index([status])
  @@index([privyUserId])
  @@index([expiresAt])
  @@map("privy_mm_pending")
}

// ═══════════════════════════════════════════════════════════════════════════
// PLATFORM CONFIG (replaces Supabase config table)
// ═══════════════════════════════════════════════════════════════════════════

model PlatformConfig {
  id                      String   @id @default("main")

  // Token settings
  tokenMintAddress        String   @map("token_mint_address")
  tokenSymbol             String   @default("WHEEL") @map("token_symbol")
  tokenDecimals           Int      @default(6) @map("token_decimals")

  // Feature flags
  flywheelActive          Boolean  @default(true) @map("flywheel_active")
  marketMakingEnabled     Boolean  @default(true) @map("market_making_enabled")
  feeCollectionEnabled    Boolean  @default(true) @map("fee_collection_enabled")

  // Fee settings
  feeThresholdSol         Decimal  @default(0.1) @map("fee_threshold_sol") @db.Decimal(20, 9)
  feePercentage           Int      @default(100) @map("fee_percentage")
  platformFeePercentage   Int      @default(10) @map("platform_fee_percentage")

  // WHEEL trading limits
  wheelMinBuySol          Decimal  @default(0.01) @map("wheel_min_buy_sol") @db.Decimal(20, 9)
  wheelMaxBuySol          Decimal  @default(0.1) @map("wheel_max_buy_sol") @db.Decimal(20, 9)
  wheelMinSellSol         Decimal  @default(0.01) @map("wheel_min_sell_sol") @db.Decimal(20, 9)
  wheelMaxSellSol         Decimal  @default(0.1) @map("wheel_max_sell_sol") @db.Decimal(20, 9)

  // Trading settings
  minBuyAmountSol         Decimal  @default(0.01) @map("min_buy_amount_sol") @db.Decimal(20, 9)
  maxBuyAmountSol         Decimal  @default(0.1) @map("max_buy_amount_sol") @db.Decimal(20, 9)
  buyIntervalMinutes      Int      @default(5) @map("buy_interval_minutes")
  slippageBps             Int      @default(300) @map("slippage_bps")

  // Job settings
  fastClaimIntervalSeconds Int     @default(30) @map("fast_claim_interval_seconds")
  fastClaimEnabled        Boolean  @default(true) @map("fast_claim_enabled")
  flywheelJobEnabled      Boolean  @default(true) @map("flywheel_job_enabled")

  updatedAt               DateTime @updatedAt @map("updated_at")

  @@map("platform_config")
}

// ═══════════════════════════════════════════════════════════════════════════
// PLATFORM WALLET BALANCES (replaces Supabase wallet_balances)
// ═══════════════════════════════════════════════════════════════════════════

model PlatformWalletBalance {
  id            String   @id @default(uuid())
  walletType    String   @unique @map("wallet_type") // 'dev' | 'ops' | 'wheel_dev' | 'wheel_ops'
  address       String   @map("address")
  solBalance    Decimal  @default(0) @map("sol_balance") @db.Decimal(20, 9)
  tokenBalance  Decimal  @default(0) @map("token_balance") @db.Decimal(30, 9)
  usdValue      Decimal  @default(0) @map("usd_value") @db.Decimal(20, 2)
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("platform_wallet_balances")
}

// ═══════════════════════════════════════════════════════════════════════════
// PLATFORM FEE STATS (replaces Supabase fee_stats)
// ═══════════════════════════════════════════════════════════════════════════

model PlatformFeeStats {
  id              String   @id @default("main")
  totalCollected  Decimal  @default(0) @map("total_collected") @db.Decimal(20, 9)
  todayCollected  Decimal  @default(0) @map("today_collected") @db.Decimal(20, 9)
  hourCollected   Decimal  @default(0) @map("hour_collected") @db.Decimal(20, 9)
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("platform_fee_stats")
}

// ═══════════════════════════════════════════════════════════════════════════
// AUDIT LOG (replaces Supabase audit_log)
// ═══════════════════════════════════════════════════════════════════════════

model AuditLog {
  id          String   @id @default(uuid())
  action      String
  tableName   String?  @map("table_name")
  recordId    String?  @map("record_id")
  details     Json?
  adminWallet String?  @map("admin_wallet")
  userId      String?  @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([action])
  @@index([createdAt(sort: Desc)])
  @@map("audit_log")
}

// ═══════════════════════════════════════════════════════════════════════════
// ADMIN USERS (role-based access via Privy)
// ═══════════════════════════════════════════════════════════════════════════

model AdminRole {
  id          String   @id @default(uuid())
  privyUserId String   @unique @map("privy_user_id")
  role        String   @default("viewer") // 'super_admin' | 'admin' | 'viewer'
  permissions Json     @default("[]") // Array of specific permissions
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user PrivyUser @relation(fields: [privyUserId], references: [privyUserId], onDelete: Cascade)

  @@map("admin_roles")
}

// ═══════════════════════════════════════════════════════════════════════════
// TELEGRAM USERS
// Maps Telegram IDs to Privy users (replaces Supabase telegram_users)
// ═══════════════════════════════════════════════════════════════════════════

model TelegramUser {
  id               String   @id @default(uuid())
  telegramId       BigInt   @unique @map("telegram_id")
  telegramUsername String?  @map("telegram_username")
  privyUserId      String?  @unique @map("privy_user_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  privyUser PrivyUser? @relation(fields: [privyUserId], references: [privyUserId], onDelete: SetNull)

  @@index([telegramId])
  @@map("telegram_users")
}

// ═══════════════════════════════════════════════════════════════════════════
// TELEGRAM ALERT SUBSCRIBERS
// Users subscribed to maintenance/downtime alerts
// ═══════════════════════════════════════════════════════════════════════════

model TelegramAlertSubscriber {
  id               String   @id @default(uuid())
  telegramId       BigInt   @unique @map("telegram_id")
  telegramUsername String?  @map("telegram_username")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@index([telegramId])
  @@index([isActive])
  @@map("telegram_alert_subscribers")
}

// ═══════════════════════════════════════════════════════════════════════════
// BOT STATUS
// Singleton table for maintenance mode state
// ═══════════════════════════════════════════════════════════════════════════

model BotStatus {
  id                  String    @id @default("main")
  isMaintenanceMode   Boolean   @default(false) @map("is_maintenance_mode")
  maintenanceReason   String?   @map("maintenance_reason")
  maintenanceStartedAt DateTime? @map("maintenance_started_at")
  estimatedEndTime    DateTime? @map("estimated_end_time")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@map("bot_status")
}
