// ═══════════════════════════════════════════════════════════════════════════
// PRISMA SCHEMA - PRIVY SYSTEM
// Fresh database for Privy-authenticated users (TMA)
// Legacy WHEEL token remains on Supabase
// ═══════════════════════════════════════════════════════════════════════════

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("PRIVY_DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════════════════
// PRIVY USERS
// Users authenticated via Privy (Telegram, email, or wallet)
// ═══════════════════════════════════════════════════════════════════════════

model PrivyUser {
  id               String   @id @default(uuid())
  privyUserId      String   @unique @map("privy_user_id")
  telegramId       BigInt?  @unique @map("telegram_id")
  email            String?  @unique
  walletAddress    String?  @unique @map("wallet_address")
  telegramUsername String?  @map("telegram_username")
  displayName      String?  @map("display_name")
  walletsDelegated Boolean  @default(false) @map("wallets_delegated")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  wallets         PrivyWallet[]
  tokens          PrivyUserToken[]
  pendingLaunches PrivyPendingLaunch[]

  @@map("privy_users")
}

// ═══════════════════════════════════════════════════════════════════════════
// PRIVY WALLETS
// Embedded wallets managed by Privy (no private keys stored!)
// ═══════════════════════════════════════════════════════════════════════════

model PrivyWallet {
  id            String   @id @default(uuid())
  privyUserId   String   @map("privy_user_id")
  walletType    String   @map("wallet_type") // 'dev' | 'ops'
  walletAddress String   @unique @map("wallet_address")
  privyWalletId String   @map("privy_wallet_id")
  chainType     String   @default("solana") @map("chain_type")
  createdAt     DateTime @default(now()) @map("created_at")

  user               PrivyUser            @relation(fields: [privyUserId], references: [privyUserId], onDelete: Cascade)
  devTokens          PrivyUserToken[]     @relation("DevWallet")
  opsTokens          PrivyUserToken[]     @relation("OpsWallet")
  devPendingLaunches PrivyPendingLaunch[] @relation("DevWalletLaunch")
  opsPendingLaunches PrivyPendingLaunch[] @relation("OpsWalletLaunch")

  @@unique([privyUserId, walletType])
  @@index([walletAddress])
  @@map("privy_wallets")
}

// ═══════════════════════════════════════════════════════════════════════════
// PRIVY USER TOKENS
// Tokens registered by Privy users (linked to wallets, not encrypted keys)
// ═══════════════════════════════════════════════════════════════════════════

model PrivyUserToken {
  id                  String   @id @default(uuid())
  privyUserId         String   @map("privy_user_id")
  tokenMintAddress    String   @map("token_mint_address")
  tokenSymbol         String   @map("token_symbol")
  tokenName           String?  @map("token_name")
  tokenImage          String?  @map("token_image")
  tokenDecimals       Int      @default(6) @map("token_decimals")
  devWalletId         String   @map("dev_wallet_id")
  opsWalletId         String   @map("ops_wallet_id")
  isActive            Boolean  @default(true) @map("is_active")
  isGraduated         Boolean  @default(false) @map("is_graduated")
  launchedViaTelegram Boolean  @default(false) @map("launched_via_telegram")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  user          PrivyUser           @relation(fields: [privyUserId], references: [privyUserId], onDelete: Cascade)
  devWallet     PrivyWallet         @relation("DevWallet", fields: [devWalletId], references: [id])
  opsWallet     PrivyWallet         @relation("OpsWallet", fields: [opsWalletId], references: [id])
  config        PrivyTokenConfig?
  flywheelState PrivyFlywheelState?
  transactions  PrivyTransaction[]
  claims        PrivyClaimHistory[]

  @@unique([privyUserId, tokenMintAddress])
  @@index([tokenMintAddress])
  @@index([isActive])
  @@map("privy_user_tokens")
}

// ═══════════════════════════════════════════════════════════════════════════
// PRIVY TOKEN CONFIG
// Per-token flywheel and market making configuration
// ═══════════════════════════════════════════════════════════════════════════

model PrivyTokenConfig {
  id                    String   @id @default(uuid())
  privyTokenId          String   @unique @map("privy_token_id")
  flywheelActive        Boolean  @default(false) @map("flywheel_active")
  marketMakingEnabled   Boolean  @default(false) @map("market_making_enabled")
  autoClaimEnabled      Boolean  @default(true) @map("auto_claim_enabled")
  feeThresholdSol       Decimal  @default(0.01) @map("fee_threshold_sol") @db.Decimal(20, 9)
  minBuyAmountSol       Decimal  @default(0.01) @map("min_buy_amount_sol") @db.Decimal(20, 9)
  maxBuyAmountSol       Decimal  @default(0.1) @map("max_buy_amount_sol") @db.Decimal(20, 9)
  maxSellAmountTokens   Decimal  @default(1000000) @map("max_sell_amount_tokens") @db.Decimal(30, 9)
  buyIntervalMinutes    Int      @default(5) @map("buy_interval_minutes")
  slippageBps           Int      @default(300) @map("slippage_bps")
  algorithmMode         String   @default("simple") @map("algorithm_mode")
  targetSolAllocation   Int      @default(30) @map("target_sol_allocation")
  targetTokenAllocation Int      @default(70) @map("target_token_allocation")
  rebalanceThreshold    Int      @default(10) @map("rebalance_threshold")
  useTwap               Boolean  @default(true) @map("use_twap")
  twapThresholdUsd      Decimal  @default(50) @map("twap_threshold_usd") @db.Decimal(20, 2)
  tradingRoute          String   @default("auto") @map("trading_route")
  updatedAt             DateTime @updatedAt @map("updated_at")

  token PrivyUserToken @relation(fields: [privyTokenId], references: [id], onDelete: Cascade)

  @@index([flywheelActive])
  @@map("privy_token_config")
}

// ═══════════════════════════════════════════════════════════════════════════
// PRIVY FLYWHEEL STATE
// Algorithm state for recovery after restarts
// ═══════════════════════════════════════════════════════════════════════════

model PrivyFlywheelState {
  id                     String    @id @default(uuid())
  privyTokenId           String    @unique @map("privy_token_id")
  cyclePhase             String    @default("buy") @map("cycle_phase")
  buyCount               Int       @default(0) @map("buy_count")
  sellCount              Int       @default(0) @map("sell_count")
  sellPhaseTokenSnapshot Decimal   @default(0) @map("sell_phase_token_snapshot") @db.Decimal(30, 9)
  sellAmountPerTx        Decimal   @default(0) @map("sell_amount_per_tx") @db.Decimal(30, 9)
  lastTradeAt            DateTime? @map("last_trade_at")
  consecutiveFailures    Int       @default(0) @map("consecutive_failures")
  lastFailureReason      String?   @map("last_failure_reason")
  lastFailureAt          DateTime? @map("last_failure_at")
  pausedUntil            DateTime? @map("paused_until")
  totalFailures          Int       @default(0) @map("total_failures")
  lastCheckedAt          DateTime? @map("last_checked_at")
  lastCheckResult        String?   @map("last_check_result")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  token PrivyUserToken @relation(fields: [privyTokenId], references: [id], onDelete: Cascade)

  @@map("privy_flywheel_state")
}

// ═══════════════════════════════════════════════════════════════════════════
// PRIVY PENDING LAUNCHES
// Token launches awaiting deposit confirmation
// ═══════════════════════════════════════════════════════════════════════════

model PrivyPendingLaunch {
  id               String    @id @default(uuid())
  privyUserId      String    @map("privy_user_id")
  tokenName        String    @map("token_name")
  tokenSymbol      String    @map("token_symbol")
  tokenDescription String?   @map("token_description")
  tokenImageUrl    String?   @map("token_image_url")
  twitterUrl       String?   @map("twitter_url")
  telegramUrl      String?   @map("telegram_url")
  websiteUrl       String?   @map("website_url")
  discordUrl       String?   @map("discord_url")
  devWalletId      String    @map("dev_wallet_id")
  opsWalletId      String    @map("ops_wallet_id")
  status           String    @default("awaiting_deposit")
  depositAddress   String    @map("deposit_address")
  minDepositSol    Decimal   @default(0.5) @map("min_deposit_sol") @db.Decimal(20, 9)
  expiresAt        DateTime  @map("expires_at")
  launchedAt       DateTime? @map("launched_at")
  retryCount       Int       @default(0) @map("retry_count")
  lastError        String?   @map("last_error")
  tokenMintAddress String?   @map("token_mint_address")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  user      PrivyUser   @relation(fields: [privyUserId], references: [privyUserId])
  devWallet PrivyWallet @relation("DevWalletLaunch", fields: [devWalletId], references: [id])
  opsWallet PrivyWallet @relation("OpsWalletLaunch", fields: [opsWalletId], references: [id])

  @@index([status])
  @@index([expiresAt])
  @@map("privy_pending_launches")
}

// ═══════════════════════════════════════════════════════════════════════════
// PRIVY TRANSACTIONS
// All trading transactions (buy, sell, transfer, claim)
// ═══════════════════════════════════════════════════════════════════════════

model PrivyTransaction {
  id            String    @id @default(uuid())
  privyTokenId  String    @map("privy_token_id")
  type          String    // 'buy' | 'sell' | 'transfer' | 'claim'
  amount        Decimal   @db.Decimal(30, 9)
  amountUsd     Decimal?  @map("amount_usd") @db.Decimal(20, 2)
  message       String?
  signature     String?   @unique
  status        String    @default("pending")
  inputMint     String?   @map("input_mint")
  outputMint    String?   @map("output_mint")
  inputAmount   Decimal?  @map("input_amount") @db.Decimal(30, 9)
  outputAmount  Decimal?  @map("output_amount") @db.Decimal(30, 9)
  pricePerToken Decimal?  @map("price_per_token") @db.Decimal(30, 15)
  slippageBps   Int?      @map("slippage_bps")
  tradingRoute  String?   @map("trading_route")
  errorMessage  String?   @map("error_message")
  createdAt     DateTime  @default(now()) @map("created_at")
  confirmedAt   DateTime? @map("confirmed_at")

  token PrivyUserToken @relation(fields: [privyTokenId], references: [id], onDelete: Cascade)

  @@index([privyTokenId])
  @@index([type])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("privy_transactions")
}

// ═══════════════════════════════════════════════════════════════════════════
// PRIVY CLAIM HISTORY
// Fee claims with platform fee tracking (10% platform, 90% user)
// ═══════════════════════════════════════════════════════════════════════════

model PrivyClaimHistory {
  id                   String    @id @default(uuid())
  privyTokenId         String    @map("privy_token_id")
  amountSol            Decimal?  @map("amount_sol") @db.Decimal(20, 9)
  totalAmountSol       Decimal?  @map("total_amount_sol") @db.Decimal(20, 9)
  amountUsd            Decimal?  @map("amount_usd") @db.Decimal(20, 2)
  platformFeeSol       Decimal   @map("platform_fee_sol") @db.Decimal(20, 9)
  userReceivedSol      Decimal   @map("user_received_sol") @db.Decimal(20, 9)
  transactionSignature String?   @map("transaction_signature")
  claimSignature       String?   @map("claim_signature")
  transferSignature    String?   @map("transfer_signature")
  status               String    @default("completed")
  errorMessage         String?   @map("error_message")
  createdAt            DateTime  @default(now()) @map("created_at")
  claimedAt            DateTime? @map("claimed_at")
  completedAt          DateTime? @map("completed_at")

  token PrivyUserToken @relation(fields: [privyTokenId], references: [id], onDelete: Cascade)

  @@index([privyTokenId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("privy_claim_history")
}
